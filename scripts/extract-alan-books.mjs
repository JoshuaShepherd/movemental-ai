#!/usr/bin/env node
/**
 * Extract Alan Hirsch book chapters from c:\dev\alan-books-12-31-25\translation-check
 * and write lib/books/alan-hirsch-content.ts for the app reader.
 *
 * Usage: node scripts/extract-alan-books.mjs
 * Set ALAN_BOOKS_DIR to override source directory (default: c:\dev\alan-books-12-31-25\translation-check).
 */

import fs from 'fs'
import path from 'path'

const ALAN_BOOKS_DIR = process.env.ALAN_BOOKS_DIR || 'c:\\dev\\alan-books-12-31-25\\translation-check'
const OUT_FILE = path.join(process.cwd(), 'lib', 'books', 'alan-hirsch-content.ts')

const MANIFEST = [
  { sample: 1, bookSlug: 'reframation', chapterSlug: '01-moving-the-moon', chapterNumber: 1, title: 'Moving the Moon' },
  { sample: 2, bookSlug: 'reframation', chapterSlug: '03-stranded-in-grey-town', chapterNumber: 3, title: 'Stranded in Grey Town' },
  { sample: 3, bookSlug: 'reframation', chapterSlug: '05-thro-narrow-chinks-in-the-cavern', chapterNumber: 5, title: "Thro' Narrow Chinks in the Cavern" },
  { sample: 4, bookSlug: 'reframation', chapterSlug: '06-the-art-of-seeing', chapterNumber: 6, title: 'The Art of Seeing' },
  { sample: 5, bookSlug: 'untamed', chapterSlug: '00-introduction', chapterNumber: 0, title: 'Introduction' },
  { sample: 6, bookSlug: 'untamed', chapterSlug: '02-your-god-is-too-sick', chapterNumber: 2, title: 'Your God Is Too Sick' },
  { sample: 7, bookSlug: 'on-the-verge', chapterSlug: '01-on-the-verge-of-the-future', chapterNumber: 1, title: 'On the Verge of the Future' },
  { sample: 8, bookSlug: 'on-the-verge', chapterSlug: '04-apostolic-genius', chapterNumber: 4, title: 'Apostolic Genius' },
  { sample: 9, bookSlug: 'metanoia', chapterSlug: '02-metanoi-eh', chapterNumber: 2, title: 'Metanoi-eh' },
  { sample: 10, bookSlug: 'the-faith-of-leap', chapterSlug: '04-the-heros-journey', chapterNumber: 4, title: "The Hero's Journey" },
]

const BOOK_TITLES = {
  reframation: 'Reframation',
  untamed: 'Untamed',
  'on-the-verge': 'On the Verge',
  metanoia: 'Metanoia',
  'the-faith-of-leap': 'The Faith of Leap',
}

function escapeForTsTemplateLiteral(str) {
  return str.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$')
}

function main() {
  if (!fs.existsSync(ALAN_BOOKS_DIR)) {
    console.error('Source directory not found:', ALAN_BOOKS_DIR)
    console.error('Set ALAN_BOOKS_DIR or ensure c:\\dev\\alan-books-12-31-25\\translation-check exists.')
    process.exit(1)
  }

  const books = {}
  for (const row of MANIFEST) {
    const file = path.join(ALAN_BOOKS_DIR, `sample-${String(row.sample).padStart(2, '0')}-en.txt`)
    let content = ''
    if (fs.existsSync(file)) {
      content = fs.readFileSync(file, 'utf8')
    }
    if (!books[row.bookSlug]) {
      books[row.bookSlug] = {
        title: BOOK_TITLES[row.bookSlug],
        slug: row.bookSlug,
        chapters: [],
      }
    }
    const chapterTitle = row.chapterNumber === 0 ? row.title : `Chapter ${row.chapterNumber}: ${row.title}`
    books[row.bookSlug].chapters.push({
      number: row.chapterNumber === 0 ? 1 : row.chapterNumber,
      title: chapterTitle,
      slug: row.chapterSlug,
      content: content.trim(),
    })
  }

  // Sort chapters by number within each book
  for (const slug of Object.keys(books)) {
    books[slug].chapters.sort((a, b) => a.number - b.number)
  }

  const lines = [
    '// Auto-generated by scripts/extract-alan-books.mjs â€” do not edit by hand.',
    '// Source: sample-*-en.txt from alan-books-12-31-25/translation-check',
    '',
    'export interface AlanHirschChapter {',
    '  number: number',
    '  title: string',
    '  slug: string',
    '  content: string',
    '}',
    '',
    'export interface AlanHirschBookContent {',
    '  title: string',
    '  slug: string',
    '  chapters: AlanHirschChapter[]',
    '}',
    '',
    'export const ALAN_HIRSCH_BOOK_CONTENT: Record<string, AlanHirschBookContent> = {',
  ]

  for (const [bookSlug, book] of Object.entries(books)) {
    lines.push(`  '${bookSlug}': {`)
    lines.push(`    title: '${book.title.replace(/'/g, "\\'")}',`)
    lines.push(`    slug: '${book.slug}',`)
    lines.push('    chapters: [')
    for (const ch of book.chapters) {
      const escaped = escapeForTsTemplateLiteral(ch.content)
      lines.push(`      { number: ${ch.number}, title: ${JSON.stringify(ch.title)}, slug: ${JSON.stringify(ch.slug)}, content: \`${escaped}\` },`)
    }
    lines.push('    ],')
    lines.push('  },')
  }

  lines.push('}')
  lines.push('')

  const outDir = path.dirname(OUT_FILE)
  if (!fs.existsSync(outDir)) {
    fs.mkdirSync(outDir, { recursive: true })
  }
  fs.writeFileSync(OUT_FILE, lines.join('\n'), 'utf8')
  console.log('Wrote', OUT_FILE)
}

main()
